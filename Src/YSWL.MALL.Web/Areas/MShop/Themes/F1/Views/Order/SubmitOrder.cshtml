@{
    Layout = "~/Areas/MShop/Themes/F1/Views/Shared/_BaseLayout.cshtml";
    ViewBag.Title = "订单";
}
  @model YSWL.MALL.Model.Shop.Products.ShoppingCartInfo
               
 @section head{
    <script src="/Scripts/jquery/jquery.guid.js" type="text/javascript"></script>
    <script src="/Scripts/jquery/maticsoft.selectregion.js" handle="/RegionHandle.aspx" isnull="true" type="text/javascript"></script>
    <script src="/Scripts/jquery.cookie.js" type="text/javascript"></script>
}
@section foot{
    <script src="/Scripts/jqueryui/maticsoft.jqueryui.dialog.min.js" type="text/javascript"></script>
    <script src="/Areas/MShop/Themes/F1/Content/Scripts/Pay/SubmitOrder.js" type="text/javascript"></script>
    <script type="text/javascript">

        $(function () {
            $(".redu").die("click").live("click", function () {//减
                var count = parseInt($(this).next().text());
                var itemId = $(this).parent().attr("ItemId");
                if (count == 1) {
                    if (confirm("您确定要删除该商品吗？")) {
                        deleteCartItem(itemId);
                    }
                } else {
                    $(this).next().text(count - 1);
                    $.ajax({
                        type: "POST",
                        dataType: "text",
                        async: false,
                        url: $YSWL.BasePath + "ShoppingCart/UpdateItemCount?s=" + new Date().format('yyyyMMddhhmmssS'),
                        data: { ItemId: itemId, Count: count - 1 },
                        success: function (data) {
                            if (data != "No") {
                                window.location = $YSWL.BasePath + "Order/SubmitOrder";
                            } else {
                                ShowFailTip("服务器繁忙，请稍候再试！");
                            }
                        }
                    });
                }
            });

            $(".add").die("click").live("click", function () {//加
                var count = parseInt($(this).prev().text());
                $(this).prev().text(count + 1);
                var itemId = $(this).parent().attr("ItemId");
                $.ajax({
                    type: "POST",
                    dataType: "text",
                    async: false,
                    url: $YSWL.BasePath + "ShoppingCart/UpdateItemCount?s=" + new Date().format('yyyyMMddhhmmssS'),
                    data: { ItemId: itemId, Count: count + 1 },
                    success: function (data) {
                        if (data != "No") {
                            window.location = $YSWL.BasePath + "Order/SubmitOrder";
                        } else {
                            ShowFailTip("服务器繁忙，请稍候再试！");
                        }
                    }
                });
            });


            $('#order-submit').click(function () {//提交订单
                var addressId = $('#step-1 .step-content').attr("addressId");
                if (!addressId || addressId < 1) {
                    ShowFailTip("请修改收货人信息!");
                    return false;
                }
                var payId = $('#step-2').find('#PaymentModeId').val();
                if (!payId || payId < 1) {
                    ShowFailTip("请修改支付方式后提交订单!");
                    return false;
                }
                var shipId = $('#step-2').find('#ShippingTypeId').val();
                if (!shipId || shipId < 1) {
                    ShowFailTip("请修改配送方式后提交订单!");
                    return false;
                }
                var conpon = $("#hfcoupon").val();
                SubmitOrder(this, addressId, shipId, payId, conpon);
            });
           
            //是否可用优惠券
            IsUseCoupon();
        });
        
        //删除购物车项
        var deleteCartItem = function (itemId) {
            $.ajax({
                type: "POST",
                dataType: "text",
                url: $YSWL.BasePath + "ShoppingCart/RemoveItem",
                data: { ItemIds: itemId },
                success: function (data) {
                    if (data != "No") {
                        window.location = $YSWL.BasePath + "Order/SubmitOrder";
                    } else {
                        ShowFailTip("服务器繁忙，请稍候再试！");
                    }
                }
            });
        };


        var CheckLogin = function () {
            var islogin;
            $.ajax({
                url: $YSWL.BasePath + "Account/AjaxIsLogin",
                type: 'post',
                dataType: 'text',
                timeout: 10000,
                async: false,
                success: function (resultData) {
                    if (resultData != "True") {
                        islogin = false;
                        return false;
                    } else {
                        islogin = true;
                        return true;
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                }
            });
            return islogin;
        };
        //是否可用优惠券
        function IsUseCoupon() {
            var useCoupon = $('#hidUseCoupon').val();
            //不是限时抢购/团购
            if (!$.getUrlParam('c') && !$.getUrlParam('g')) {
                $('#orderCouponItem').show();
                return;
            }
            //限时抢购/团购 开启了使用优惠劵
            if (($.getUrlParam('c') || $.getUrlParam('g')) && useCoupon.toLocaleLowerCase() == 'true') {
                $('#orderCouponItem').show();
            }
        }
        //获取赠品及包邮信息
        function GetActivList(couponPrice) {
            $('#activList').load($YSWL.BasePath + 'Order/ActivList', { coupPrice: couponPrice });
        }
        //是否包邮
        function IsFullFreeShipping() {
            if ($('#hidFullFreeShipping').length > 0 && $('#hidFullFreeShipping').val() && $('#hidFullFreeShipping').val().toLocaleLowerCase() == 'true') {
                return true;
            } else {
                return false;
            }
        }
	
	
	 //获取要购买的商品的库存
        function GetBuyProdStock() {
            $.ajax({
                type: "POST",
                dataType: "json",
                url: $YSWL.BasePath + "Order/GetBuyProdStock",
                async: false,
                success: function (resultJson) {
                    if (resultJson.STATUS == "OK") {
                        var datajson = $.parseJSON(resultJson.DATA);
                        var tiptext = '';
                        var isred = false;
                        for (var i = 0; i < datajson.length; i++) {
                            if (parseInt(datajson[i].stock) <= 0) {
                                tiptext = '无货';
                                isred = true;
                            } else if (parseInt(datajson[i].stock) < parseInt(datajson[i].quantity)) {
                                tiptext = '库存不足';
                                isred = true;
                            } else {
                                tiptext = '有货';
                                isred = false;
                            }
                            if ($('#items_' + datajson[i].sku + ' .stockTip').length > 0) {
                                if (isred) {
                                    $('#items_' + datajson[i].sku + ' .stockTip').text(tiptext).addClass('red');
                                }else {
                                                                    $('#items_' + datajson[i].sku + ' .stockTip').text('').removeClass('red');
                                                                }
                            }
                        }
                    }
                }
            });

 
               
        }

    </script>
}

 <style>		
		@@media ( max-height: 320px ) {
			.ui-footer-fixed {
				position: absolute;
			}
		}
		@@media ( min-height: 320px ) {
			.ui-header-fixed {
				position: fixed;
			}	
			.ui-footer-fixed {
				position: fixed;
			}
		}
	</style>
<div data-role="content" id="cart-layout" class="ui-content" role="main">
  <input  type="hidden" id="hidUseCoupon" value="@ViewBag.PromotionsIsUseCoupon"/>
  <input  type="hidden" id="hdIsMultiDepot" value="@ViewBag.IsMultiDepot"/>
    <!----购物车开始---->
    <div id="cartlist">
    @Html.Action("CartList", "ShoppingCart")
    </div>	
    <!---购物车结束--->
    

    <div class="contact-info">	
    <input type="hidden" id="SkuInfo" value="@ViewBag.SkuInfo"/>
    <input type="hidden" id="SkuCount" value="@ViewBag.SkuCount"/>
      											
        <ul data-role="listview" data-inset="true" data-theme="d" class="ui-listview ui-listview-inset ui-corner-all ui-shadow">
            <li data-role="list-divider" role="heading" class="ui-li ui-li-divider ui-bar-b ui-first-child">收货人信息</li>
            <li style="padding: 5px 10px 5px 10px" class="ui-li ui-li-static ui-btn-up-d ui-last-child" id="step-1">
 	          @Html.Action("ShowAddress", "Order")
            </li>
        </ul>
         <ul data-role="listview" data-inset="true" data-theme="d" class="ui-listview ui-listview-inset ui-corner-all ui-shadow">
            <li data-role="list-divider" role="heading" class="ui-li ui-li-divider ui-bar-b ui-first-child">支付及配送方式</li>
            <li style="padding: 5px 10px 5px 10px" class="ui-li ui-li-static ui-btn-up-d ui-last-child" id="step-2">
 	          @Html.Action("ShowPayAndShip", "Order")
            </li>
        </ul>
         <ul  id="orderCouponItem"  style="display:none;" data-role="listview" data-inset="true" data-theme="d" class="ui-listview ui-listview-inset ui-corner-all ui-shadow">
            <li data-role="list-divider" role="heading" class="ui-li ui-li-divider ui-bar-b ui-first-child">优惠劵</li>
            <li style="padding: 5px 10px 5px 10px" class="ui-li ui-li-static ui-btn-up-d ui-last-child" id="step-3" >
 	           @Html.Action("ShowCoupon", "Order", new { cartInfo = Model })
            </li>
        </ul>
        <ul data-role="listview" data-inset="true" data-theme="d" class="ui-listview ui-listview-inset ui-corner-all ui-shadow">
            <li style="padding: 5px 10px 5px 10px" class="ui-li ui-li-static ui-btn-up-d ui-last-child" id="step-2">
                <table style="padding: 0; margin: 0; width: 100%;">
                    <tbody><tr >
                               <td class="align_right" width="80px"><label  class="ui-input-text">商品金额：</label></td>
                               <td>
                                   <label class="ui-input-text font_family_sans" > ￥@ViewBag.ProductTotal.ToString("F") </label>  
                               </td>
                           </tr>
                          
                        <tr>
                            <td class="align_right" width="80px"><label  class="ui-input-text">+ 运费：</label></td>
                            <td>
                                <label class="price ui-input-text font_family_sans" id="freightPriceId" freightPrice="0">@ViewBag.Freight.ToString("F")</label>
                            </td>
                        </tr>

                        <tr>
                            <td class="align_right" width="80px"><label  class="ui-input-text ">- 促销：</label></td>
                            <td>
                                <label class="ui-input-text font_family_sans">￥@ViewBag.TotalPromPrice.ToString("F") </label> 
                            </td>
                        </tr> 
                        <tr>
                            <td class="align_right" width="80px"><label  class="ui-input-text">- 优惠：</label></td>
                            <td>
                                <label class="ui-input-text font_family_sans" id="couponPriceId" couponPrice="0">￥0.00</label>
                            </td>
                        </tr>	
                        <tr>
                            <td class="align_right" width="80px"><label   class="ui-input-text">应付总额：</label></td>
                            <td>
                                <strong class="font_family_sans" id="payPriceId" style="color:#7aad33;" BasePrice="@ViewBag.TotalPrice"  >
                                    ￥@ViewBag.TotalPrice.ToString("F")
                                </strong>
                            </td>
                        </tr>
                            
                        
                    </tbody></table>

            </li>
        </ul>
            <!--赠品-->
    <div id="activList"></div>
    <!--赠品-->
    
     <div> 
          <a data-role="button" href="javascript:;" rel="external"  id="order-submit"  data-theme="b" data-corners="true" data-shadow="true" data-iconshadow="true" data-wrapperels="span" class="ui-btn ui-btn-up-b ui-shadow ui-btn-corner-all">
                <span class="ui-btn-inner"><span class="ui-btn-text">提交订单</span></span>
            </a>
     </div>
</div>

</div>