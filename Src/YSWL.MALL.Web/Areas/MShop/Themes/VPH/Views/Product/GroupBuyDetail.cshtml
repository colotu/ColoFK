@{
    Layout = "/Areas/MShop/Themes/VPH/Views/Shared/_ShopBaseLayout.cshtml";
}
@using YSWL.MALL.Model.Shop.Products
@model YSWL.MALL.ViewModel.Shop.ProductModel
<link href="/Scripts/PhotoSwipe/photoswipe.css" rel="stylesheet" type="text/css" />
<link href="/Scripts/PhotoSwipe/styles.css" rel="stylesheet" type="text/css" />
<script src="/Scripts/PhotoSwipe/klass.min.js" type="text/javascript"></script>
<script src="/Scripts/jquery/maticsoft.jquery.min.js" type="text/javascript"></script>
<script src="/Scripts/jquery/maticsoft.img.min.js" type="text/javascript"></script>
<link href="/Areas/MShop/Themes/VPH/Content/Css/productdetail.css" rel="stylesheet"
    type="text/css" />
<link href="/Scripts/jqueryui/base/jquery-ui-1.9.2.min.css" rel="stylesheet" type="text/css" />
<script src="/Scripts/jqueryui/jquery-ui-1.9.2.custom.js" type="text/javascript"></script>
<script src="/Areas/MShop/Themes/VPH/Content/Scripts/productdetail.js" type="text/javascript"></script>
<script src="/Areas/MShop/Themes/VPH/Content/Scripts/SKU.js" type="text/javascript"></script>
<script src="/Areas/MShop/Themes/VPH/Content/Scripts/timeCountDown.js" type="text/javascript"></script>
<script src="/Scripts/PhotoSwipe/photoswipe.jquery.min.js" type="text/javascript"></script>
<script src="/Scripts/jquery.cookie.js" type="text/javascript"></script>
<style type="text/css">
    .footer
    {
        display: none !important;
    }
</style>
<script type="text/javascript">
    pagename = "groupbuy_detail";
    $(function () {
        $("#body").css("padding-top", "44px");

    })

    (function (window, Util, PhotoSwipe) {
        Util.Events.domReady(function (e) {
            var instance, indicators;
            instance = $(".Touch_mer_smallImg").photoSwipe(
                {
                    target: window.document.querySelectorAll('#goods_images')[0],
                    preventHide: true,
                    autoStartSlideshow: true,
                    captionAndToolbarHide: true,
                    fadeInSpeed: 1000,
                    faseOutSpeed: 1000,
                    getImageSource: function (obj) {
                        return $(obj).attr("src");
                    },
                    getImageCaption: function (obj) {
                        return $(obj).attr("alt");
                    },
                    getImageMetaData: function (obj) {
                        return {
                            longDescription: obj.getAttribute(obj, 'alt')
                        };
                    }
                }
            );
            indicators = window.document.querySelectorAll('#pro_pagination em');

            // onDisplayImage - set the current indicator
            instance.addEventHandler(PhotoSwipe.EventTypes.onDisplayImage, function (e) {
                var i, len;
                for (i = 0, len = indicators.length; i < len; i++) {
                    indicators[i].setAttribute('class', '');
                }
                indicators[e.index].setAttribute('class', 'on');
                var src = $("#PhotoSwipeTarget").find(".ps-carousel").find(".ps-carousel-content").find("img").attr("src");
            });
            instance.show(0);
        });

    } (window, window.Code.Util, window.Code.PhotoSwipe));
</script>
@if (Model != null)
{
    <header id="header" class="header clearfix">
	    <div class="head_left fl"><a href="javascript:;" onclick="history.go(-1)"><span class="h_back"></span></a></div>
	     <span class="headtit">@Model.ProductInfo.ProductName</span>
	    <div class="head_right fr"><a href="@(ViewBag.BasePath)"><span class="h_home"></span></a></div>
	</header>
    <div class="space10">
    </div>
    <input id="hdProductId" type="hidden"  value="@Model.ProductInfo.ProductId"/>
    <input id="hdsuppId"   type="hidden" value="@Model.ProductInfo.SupplierId"/>
    <input id="hfGroupBuyId" type="hidden" value="@Model.ProductInfo.GroupBuy.GroupBuyId" />
 
    <div id="wapModalsbox">
        <div id="goods_detail" class="aposition">
            <div id="goods_images" class="goods_images" style="overflow: hidden; visibility: visible;">
                @if (Model != null && Model.ProductImages != null)
                {
                    for (var i = 0; i < Model.ProductImages.Count; i++)
                    {
                    <span>
                        <img  item="@YSWL.MALL.Web.Components.FileHelper.GeThumbImage(Model.ProductImages[i].ThumbnailUrl1, "T185X254_")" src="@YSWL.MALL.Web.Components.FileHelper.GeThumbImage(Model.ProductImages[i].ThumbnailUrl1, "T185X254_")"
                                     width="256" height="323" alt="@Model.ProductInfo.ProductName" class="Touch_mer_smallImg active"
                                     style="display: inline;"/>
                    </span>
                   
                    }
                }
            </div>
            <div class="slideControl clearfix">
                <div id="pro_pagination">
                    @if (Model != null && Model.ProductImages != null)
                    {
                        foreach (ProductImage productImage in Model.ProductImages)
                        {
                        <em class="on">1</em>
                        }
                    }
                </div>
            </div>
            <div class="goods_info">
                <form name="cartForm" action="" method="post">
                <h1>
                    @Model.ProductInfo.ProductName</h1>
                <p class="pricediv clearfix">
                    团购价：<span class="g_d_price">¥@Model.ProductInfo.GroupBuy.Price.ToString("F")</span>
                    <span class="prf05"></span><span class="fontstyle">¥@(Model.ProductInfo.MarketPrice.HasValue ? Model.ProductInfo.MarketPrice.Value.ToString("F") : "0")</span>
                </p>
	 <p class="pricediv clearfix">	团购地：<span >@ViewBag.GroupBuyRegoinFull</span> </p>
              
              @if (Model.ProductInfo.GroupBuy.EndDate > DateTime.Now &&
                    Model.ProductInfo.SaleStatus == 1 &&
                    Model.ProductInfo.GroupBuy.BuyCount < Model.ProductInfo.GroupBuy.MaxCount && 
                    ViewBag.IsMultiDepot)
               {
                   //已开启了分仓
                    
                   @Html.Partial("/Areas/MShop/Themes/VPH/Views/Partial/_RegoinLayer.cshtml")
               }
		
                <p class="space5">
                </p>
                <p class="clear">
                </p>
                <div id="divBuyInfo" class="proshow_pl" style="background: none; height: 95px" >
                    <label id="productDate" date="@((Model.ProductInfo.GroupBuy.EndDate.ToUniversalTime() - Convert.ToDateTime("1970-01-01")).TotalMilliseconds.ToString("0"))">
                        <span class="fl">剩余时间：</span>
                        </label>
                    <div class="txtenddate">
                        <span><span id="dayEnd">0</span>天<span id="hourEnd">0</span>时 <span id="minEnd">0</span>分
                            <span id="secEnd">0</span>秒 </span>
                    </div>
                    <div>
                    团购上限数量<span>@(Model.ProductInfo.GroupBuy.MaxCount)</span>,满足<span>@(Model.ProductInfo.GroupBuy.GroupCount)</span>
                    团购成立！<br />
                        已有<span>@(Model.ProductInfo.GroupBuy.BuyCount)</span>参团 数量有限 请尽快购买！
                        </div>
                </div>
                <div class="proshow_pl" id="closeActivity" style="background: none; margin-right: 10px;
                    display: none;">
                    <p class="tipsOrg loud dib">
                        非常抱歉, 该活动已过期!</p>
                </div>
                <div class="proshow_pl" id="closeArrivingNotifyMess" style="background: none; margin-right: 10px;
                    display: none;">
                    <p class="tipsOrg loud dib">
                        非常抱歉, 此商品已售罄!</p>
                </div>
                <div class="choiceOptions c6">
                    <div id="SKUOptions" class="proshowlxtext  " style="padding-left: 0;">
                        @Html.Action("OptionSKU", "Product", new { ProductId = Model.ProductInfo.ProductId, SuppId = Model.ProductInfo.SupplierId, viewName = "_OptionSKU" })
                    </div>
                </div>
                <div class="sku-selected-title mt15 c9" style="  clear: left; padding-left: 8px;" id="divSelectInfo">
                </div>
                <div class="p_detail_hd">
                    <p class="fontdark">
                        <a href="@(ViewBag.BasePath)product/productdesc/@Model.ProductInfo.ProductId" style="width: 100%;display: block">
                            商品详情<span style="float: right">></span></a>
                    </p>
                     <p style="display: none">
                        <span class="fontdark">商品编号：</span>@Model.ProductInfo.ProductCode</p>
                    @*  @Html.Action("OptionAttr", new { ProductId = Model.ProductInfo.ProductId })*@
                    <div class="Origin" style="border: none; margin: 0; padding: 0;">
                        @Html.Action("ProductRelation", "Product", new { id = Model.ProductInfo.ProductId, Top = 3, viewName = "_ProductRelation" })</div>
                    <div class="dashline3">
                    </div>
                </div>
                </form>
            </div>
        </div>
    </div>
 
    <div class="bottomdiv clearfix">
        <div class="inner clearfix">
            <a class="fl cart_time" href="@(ViewBag.BasePath)sc/ci"><em class="num_cart hide"></em>
                <span class="carticon fl"></span><span class="num_cunt hide"></span></a><a href="javascript:;" class="btn_more" id="btnProductFav" productId="@Model.ProductInfo.ProductId" style="width: 50px;float: left;margin-left: 10%;">
                    <img src="/Areas/MShop/Themes/VPH/Content/images/icon_concern.png" />关注</a>
            <span class="btn-tbl-cell" style="display: none"><a class="btn-add-cart link" id="btnQukBuy"   itemid=""  groupbuyid="@Model.ProductInfo.GroupBuy.GroupBuyId">
                加入购物车</a> </span>
            <div class="fr btn_sure " id="btnAddToCart" DefaultText="立刻购买"  groupbuyid="@Model.ProductInfo.GroupBuy.GroupBuyId">
                立刻购买</div>
        </div>
    </div>


}
<script type="text/javascript">
    $(function() {
        var myclass = new CountDown();
        var endDate = $("#productDate").attr("date");
         var dateEnd =new Date(parseInt(endDate));
        var dateNow = new Date();
        var dateCount = dateEnd.getTime() - dateNow.getTime();
        if (dateCount > 0) {
            myclass.init({
                id: 'txtenddate',
                //天数
                day_Dom: $("#dayEnd"),
                //小时
                hour_Dom: $("#hourEnd"),
                //分钟
                min_Dom: $("#minEnd"),
                //秒
                sec_Dom: $("#secEnd"),
                endTime: endDate
            });
        } else {
            $("#closeActivity").show();
            $('#iteminfo').parent().find('#btnAddToCart').removeClass('addCart').addClass('addCart-gray');
            $('#iteminfo #divBuyInfo').hide();
            $('#iteminfo #divSelectInfo').empty();
        }
        if (@Model.ProductInfo.SaleStatus !== 1) {
            $('#iteminfo').parent().find('#btnAddToCart').removeClass('addCart').addClass('addCart-gray');
            $('#iteminfo #divBuyInfo').hide();
            $('#iteminfo #divSelectInfo').empty();
            $('#iteminfo #closeArrivingNotifyMess').text("非常抱歉, 此商品已下架!");
            $('#iteminfo #closeArrivingNotifyMess').show();
        }

        var maxCount = parseInt('@Model.ProductInfo.GroupBuy.MaxCount');
        var buyCount = parseInt('@Model.ProductInfo.GroupBuy.BuyCount');
        if (buyCount >= maxCount) {
            $("#closeArrivingNotifyMess").show();
            $('#iteminfo').parent().find('#btnAddToCart').removeClass('addCart').addClass('addCart-gray');
            $('#iteminfo #divBuyInfo').hide();
            $('#iteminfo #divSelectInfo').empty();
        }

        $("#btnAddToCart").unbind('click').bind('click',function () {
            if ($(this).hasClass('addCart-gray')) return false;
            var sku = $(this).attr('itemid');
            if (!sku) {
                $('#iteminfo,#iteminfo a').effect('highlight', 500);
                 ShowFailTip('请选择商品规格属性！');
                return false;
            }
            var groupbuyid = $("#hfGroupBuyId").val();
            $.ajax({
                type: "POST",
                dataType: "text",
                url: "@(ViewBag.BasePath)Product/CkeckCount",
                async: false,
                data: { GroupBuyId: groupbuyid },
                success: function (data) {
                    if (data == "Ok") {
                        location.href = " @(ViewBag.BasePath)Order/SubmitOrder?sku=" + sku + "&g=" + groupbuyid;
                    }
                    else {
                        $("#closeArrivingNotifyMess").show();
                        $('#iteminfo').parent().find('#btnAddToCart').removeClass('addCart').addClass('addCart-gray');
                        $('#iteminfo #divBuyInfo').hide();
                        $('#iteminfo #divSelectInfo').empty();
                    }
                }
            });
        });
    })
</script>
