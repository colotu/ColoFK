@{
    Layout = "~/Areas/MShop/Themes/VPH/Views/Shared/_BaseLayout.cshtml";
}
@section head{
    <link href="/Scripts/jqueryui/red/jquery-ui-1.9.2.min.css" rel="stylesheet" type="text/css" />
    <script src="/Scripts/jquery/jquery.guid.js" type="text/javascript"></script>
    <script src="/Scripts/jquery/maticsoft.selectregion.js" handle="/RegionHandle.aspx"
        isnull="true" type="text/javascript"></script>
        <script src="/Scripts/jquery.cookie.js" type="text/javascript"></script>
}
@section foot{
    <script src="/Scripts/jqueryui/jquery-ui-1.9.2.min.js" type="text/javascript"></script>
    <script src="/Scripts/jqueryui/maticsoft.jqueryui.dialog.min.js" type="text/javascript"></script>
    <script src="/Areas/MShop/Themes/VPH/Content/Scripts/Pay/SubmitOrder.js" type="text/javascript"></script>
    <script type="text/javascript">
        $(function () {
            $('#order-submit').click(function () {
                var addressId = $('#receiveInfo .clearfix').attr("addressId");
                if (!addressId || addressId < 1) {
                    $.alertEx('请修改收货人信息!', function () {
                        $('#step-1').effect('highlight', 1000);
                        //$('#step-1').effect('shake');
                    });
                    return false;
                }
                var payId = $('.in_pay').find('#PaymentModeId').val();
                if (!payId || payId < 1) {
                    $.alertEx('请修改支付方式后提交订单!', function () {
                        $('#step-2').effect('highlight', 1000);
                    });
                    return false;
                }
                var shipId = $('.in_pay').find('#ShippingTypeId').val();
                if (!shipId || shipId < 1) {
                    $.alertEx('请修改配送方式后提交订单!', function () {
                        $('#step-2').effect('highlight', 1000);
                    });
                    return false;
                }
                var conpon = $("#hfcoupon").val();
                SubmitOrder(this, addressId, shipId, payId, conpon);
            });
            //是否可用优惠券
            IsUseCoupon();
        });
        var CheckLogin = function () {
            var islogin;
            $.ajax({
                url: $YSWL.BasePath + "Account/AjaxIsLogin",
                type: 'post',
                dataType: 'text',
                timeout: 10000,
                async: false,
                success: function (resultData) {
                    if (resultData != "True") {
                        islogin = false;
                        return false;
                    } else {
                        islogin = true;
                        return true;
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                }
            });
            return islogin;
        };
        //是否可用优惠券
        function IsUseCoupon() {
            var useCoupon = $('#hidUseCoupon').val();
            //不是限时抢购/团购
            if (!$.getUrlParam('c') && !$.getUrlParam('g')) {
                $('#orderCouponItem').show();
                return;
            }
            //限时抢购/团购 开启了使用优惠劵
            if (($.getUrlParam('c') || $.getUrlParam('g')) && useCoupon.toLocaleLowerCase() == 'true') {
                $('#orderCouponItem').show();
            }
        }
        //获取赠品及包邮信息
        function GetActivList(couponPrice) {
            $('#activList').load($YSWL.BasePath + 'Order/ActivList', { coupPrice: couponPrice });
        }
        //是否包邮
        function IsFullFreeShipping() {
            if ($('#hidFullFreeShipping').length > 0 && $('#hidFullFreeShipping').val() && $('#hidFullFreeShipping').val().toLocaleLowerCase() == 'true') {
                return true;
            } else {
                return false;
            }
        }

        //获取要购买的商品的库存
        function GetBuyProdStock() {
            $.ajax({
                type: "POST",
                dataType: "json",
                url: $YSWL.BasePath + "Order/GetBuyProdStock",
                async: false,
                success: function (resultJson) {
                    if (resultJson.STATUS == "OK") {
                        var datajson = $.parseJSON(resultJson.DATA);
                        var isShow = false;
                        var htmlstr = '<div class="checktit font14"  style="color: #F00;padding-left: 8px;">缺货及失效商品</div> <div class="gou_nrtext"  style="background: none;padding: 6px 5px 0 6px;">';
                        for (var i = 0; i < datajson.length; i++) {
                            if (parseInt(datajson[i].salestatus) != 1 || parseInt(datajson[i].stock) <= 0 || parseInt(datajson[i].stock) < parseInt(datajson[i].quantity)) {//无效 无货 库存不足
                                htmlstr += ' <div   class="so_f_left">   <img   width="50" height="50" src="' + datajson[i].pic.format('T50X65_') + '"/></div>';
                                isShow = true;
                            }  
                        }
                        htmlstr += '</div>';
                        if (isShow) {
                             $('#products_nostock_tip').html(htmlstr);
                        } else {
                             $('#products_nostock_tip').html('');
                        }
                    }
                }
            });
        }
    </script>
}
@model YSWL.MALL.Model.Shop.Products.ShoppingCartInfo
<input  type="hidden" id="hidUseCoupon" value="@ViewBag.PromotionsIsUseCoupon"/>
<input  type="hidden" id="hdIsMultiDepot" value="@ViewBag.IsMultiDepot"/>
		<header id="header" class="header clearfix">
	    <div class="head_left fl"><a href="javascript:;" onclick="history.go(-1);"><span class="h_back"></span></a></div>
	     <span class="headtit">填写订单</span>
	    <div class="head_right fr"><a href="@(ViewBag.BasePath)"><span class="h_home"></span></a></div>
	</header>
<div class="space10"></div>
<div data-formorder="checkoutForm">
      <input type="hidden" id="SkuInfo" value="@ViewBag.SkuInfo"/>
    <input type="hidden" id="SkuCount" value="@ViewBag.SkuCount"/>
    <input type="hidden" id="ProSale" value="@ViewBag.ProSale"/>
    <input type="hidden" id="GroupBuy" value="@ViewBag.GroupBuy"/>
    @*收货人信息*@
    @Html.Action("ShowAddress", "Order")
    
    @*支付及配送方式*@
    @Html.Action("ShowPayAndShip", "Order")
    
    @*优惠券*@
    <div class="userdiv" id="orderCouponItem" style="display: none;" data-cartforms="time">
        <div class="checktit font14"><span class="receive_time"></span>优惠券</div>
        <div class="in_pay clearfix payment-selected" > 
             @Html.Action("ShowCoupon", "Order", new { cartInfo=Model })
        </div>

    </div>
    <div class="userdiv" id="products_nostock_tip"  style="padding: 0 5px 2px 0;">
        @if (Model.Items != null)
        {
            int i = 0;//失效、无库存、库存不足 商品数
	    <div class="checktit font14"  style="color: #F00;padding-left: 8px;">缺货及失效商品</div>
             
            <div class="gou_nrtext" style="background: none; padding: 6px 5px 0 6px;">
                @foreach (var item in Model.Items)
                {
                    if (item.SaleStatus != 1 || item.Stock <= 0 || item.Stock < item.Quantity)
                    {
                        i++;
                    <div class="so_f_left">
                        <img   width="50" height="50" src="@YSWL.MALL.Web.Components.FileHelper.GeThumbImage(item.ThumbnailsUrl, "T50X65_")" /></div>        
                    }
                 }
            </div>
            <input type="hidden"  id="shixiaoshangpin" value="@i" /> //含有 失效、无库存、库存不足 商品 时才展示
                                                      <script type="text/javascript">
                                                          if (parseInt($('#shixiaoshangpin').val()) > 0) {
                                                              $('#products_nostock_tip').show();
                                                          } else {
                                                              $('#products_nostock_tip').hide();
                                                          }
                                                      </script>
            
    }
   
    </div>
    
    
    
    
    
    
    <div class="userdiv">
        <div class="checktit clearfix"><span class="pay_sum"></span>订单金额</div>
        <div class="checkcon clearfix" id="order-m-list">      
      
            <div class="sumtotal clearfix"> 
                <p>商品金额：<span class="fr" >¥@ViewBag.ProductTotal.ToString("F")</span></p> 
                <p> + 运费：<span class="fr" id="freightPriceId" freightPrice="0" >¥@ViewBag.Freight.ToString("F")</span></p>
                <p> -  促销：<span class="fr" id="promotionsPriceId">¥@ViewBag.TotalPromPrice.ToString("F")</span></p> 
                <p> - 优惠：<span class="fr"  id="couponPriceId" couponPrice="0">¥0.00</span></p>        
                <p>待支付总额：<span class="fr" id="payPriceId" BasePrice="@ViewBag.TotalPrice" TotalPrice="@ViewBag.TotalPrice">¥@ViewBag.TotalPrice.ToString("F")</span></p>
            </div>
            <input type="hidden" name="payable" value="">
        </div>
    </div>
    <input type="hidden" name="favourable_id" value="">
    
    <!--赠品-->
    <div id="activList" class="activList"></div>
    <!--赠品-->
     
    <div class="bottomdiv clearfix">
        <div class="cover_load_img w38" id="CoverloadImg"></div>
        <div class="inner clearfix">
            <div class="fl">
                <p class="cart_total">总金额：<span class="c_t_price" id="span_payPriceId">¥@ViewBag.TotalPrice.ToString("F")</span></p>
            </div>
            <div class="fr btn_sure" data-orderfrom="true" data-countorder="true" data-ordertime="541" id="order-submit">
                提交订单
            </div>
        </div>
    </div>
</div>
<div class="space10"></div>

