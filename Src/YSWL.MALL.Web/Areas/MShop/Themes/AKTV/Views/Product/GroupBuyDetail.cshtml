@{
    Layout = "/Areas/MShop/Themes/AKTV/Views/Shared/_BaseLayout.cshtml";
}
@using YSWL.MALL.Model.Shop.Products
@model YSWL.MALL.ViewModel.Shop.ProductModel
           <link href="/Scripts/PhotoSwipe/photoswipe.css" rel="stylesheet" type="text/css" />
<link href="/Areas/MShop/Themes/AKTV/Content/Css/ProductStyle.css" rel="stylesheet"/>
<script src="/Scripts/PhotoSwipe/klass.min.js" type="text/javascript"></script>
<script src="/Scripts/jquery/maticsoft.jquery.min.js" type="text/javascript"></script>
<script src="/Scripts/jquery/maticsoft.img.min.js" type="text/javascript"></script>
<link href="/Areas/MShop/Themes/AKTV/Content/Css/productdetail.css" rel="stylesheet"  type="text/css" />
<link href="/Scripts/jqueryui/base/jquery-ui-1.9.2.min.css" rel="stylesheet" type="text/css" />
<script src="/Scripts/jqueryui/jquery-ui-1.9.2.custom.js" type="text/javascript"></script>
<script src="/Areas/MShop/Themes/AKTV/Content/Scripts/productdetail.js" type="text/javascript"></script>
<script src="/Areas/MShop/Themes/AKTV/Content/Scripts/SKU.js" type="text/javascript"></script>
<script src="/Scripts/PhotoSwipe/photoswipe.jquery.min.js" type="text/javascript"></script>
<script src="/Areas/MShop/Themes/AKTV/Content/Scripts/timeCountDown.js" type="text/javascript"></script>
<script src="/Scripts/jquery.cookie.js" type="text/javascript"></script>
<script type="text/javascript">
    pagename = "groupbuy_detail";
    $(function() {
        var myPhotoSwipe = $(".view-photo a").photoSwipe({
           enableMouseWheel: true, 
           enableKeyboard: true,
					autoStartSlideshow:true,
            captionAndToolbarOpacity:1
        });
    })
</script>
 
@if (Model != null)
{
    <div id="iteminfo" data-role="page" data-add-back-btn="true">
  <input id="hdProductId" type="hidden"  value="@Model.ProductInfo.ProductId"/>
    <input id="hdsuppId"   type="hidden" value="@Model.ProductInfo.SupplierId"/>
       <input id="hfGroupBuyId" type="hidden" value="@Model.ProductInfo.GroupBuy.GroupBuyId" />
        <div class="productshow_title">
            @Model.ProductInfo.ProductName</div>
        <div class="view-photo tc">
            @* <a href="javascript:void(0)" id="i_pre" class="btn-prev">上一个</a> *@
 
            @if (Model != null && Model.ProductImages != null)
            {
                foreach (ProductImage productImage in Model.ProductImages)
                {
                        <li class="mid-img"  style="@(productImage.ThumbnailUrl1 == Model.ProductInfo.ThumbnailUrl1 ? "" : "display:none")">
                    <a href="@YSWL.MALL.Web.Components.FileHelper.GeThumbImage(productImage.ThumbnailUrl1, "T300X390_")" rel="external" >
                                                                  <img  item="@YSWL.MALL.Web.Components.FileHelper.GeThumbImage(productImage.ThumbnailUrl1, "T175X228_")" src="@YSWL.MALL.Web.Components.FileHelper.GeThumbImage(productImage.ThumbnailUrl1, "T175X228_")"   alt="@Model.ProductInfo.ProductName" />
                                                              </a>
                                                              </li>
                }
            }
        </div>
        @*     <a id="i_next" href="javascript:void(0)" class="btn-next">下一个</a>*@
         @Html.Action("StoreLayer", "Partial", new { suppId = Model.ProductInfo.SupplierId })
        <div class="productshow_jiage">
            市场价：<span>￥@(Model.ProductInfo.MarketPrice.HasValue ? Model.ProductInfo.MarketPrice.Value.ToString("F") : "0")</span><br />
            @*销售价：<strong>￥<span id="stylePrice">@Model.ProductSkus[0].SalePrice.ToString("F")</span></strong>*@
            团购价：<strong>￥<span >@Model.ProductInfo.GroupBuy.Price.ToString("F")</span></strong><br />
            团购地：<span >@ViewBag.GroupBuyRegoinFull</span>
              
              @if (Model.ProductInfo.GroupBuy.EndDate > DateTime.Now &&
                    Model.ProductInfo.SaleStatus == 1 &&
                    Model.ProductInfo.GroupBuy.BuyCount < Model.ProductInfo.GroupBuy.MaxCount && 
                    ViewBag.IsMultiDepot)
               {
                   //已开启了分仓
                    
                   @Html.Partial("/Areas/MShop/Themes/AKTV/Views/Partial/_RegoinLayer.cshtml")
               }
            </div>
        <div id="divBuyInfo" class="proshow_pl" style="background:none;height:auto;">
            <label id="productDate" date="@((Model.ProductInfo.GroupBuy.EndDate.ToUniversalTime() - Convert.ToDateTime("1970-01-01")).TotalMilliseconds.ToString("0"))">
                <span class="fl">剩余时间：</span></label>
            <div class="txtenddate"><span><span id="dayEnd">0</span>天<span id="hourEnd">0</span>时 
                                        <span id="minEnd">0</span>分 <span id="secEnd">0</span>秒
                                    </span></div>
            <div>团购上限数量<span>@(Model.ProductInfo.GroupBuy.MaxCount)</span>,满足<span>@(Model.ProductInfo.GroupBuy.GroupCount)</span> 团购成立！<br/>
            已有<span>@(Model.ProductInfo.GroupBuy.BuyCount)</span>参团 数量有限 请尽快购买！ 
            </div>
        </div>
                    <div class="proshow_pl" id="closeActivity" style="background:none;margin-right: 10px;display: none;">
                        <p class="tipsOrg loud dib">
                            非常抱歉, 该活动已过期!</p>
                    </div>
                    <div class="proshow_pl" id="closeArrivingNotifyMess" style="background:none;margin-right: 10px;display: none;height:auto;">
                        <p class="tipsOrg loud dib">
                            非常抱歉, 此商品已售罄!</p>
                    </div>
 
        <div class="choiceOptions c6">
            <div id="SKUOptions" class="proshowlxtext  " style="float: left">
                @Html.Action("OptionSKU", "Product", new { ProductId = Model.ProductInfo.ProductId, SuppId = Model.ProductInfo.SupplierId, viewName = "_OptionSKU" })
            </div>
        </div>
        <div class="sku-selected-title mt15 c9" style="clear: left; padding-left: 8px;"    id="divSelectInfo">
        </div>
        <div class="productshow_sl" style="display: none;">
            购买件数：<a href="javascript:;" class="redu" id="subtract">-</a>
            <input type="text" size="4" value="1" name="num" id="productCount" class="common-input" />
            <a href="javascript:;" id="plus" class="add">+</a> <span style="display: none">（库存@(Model.ProductSkus[0].Stock)件）</span></div>
        <div class="producshow_but">
            <div class="btn-section">
                <span class="btn-tbl-cell"><a class="btn-attention link" productId="@Model.ProductInfo.ProductId" id="btnProductFav">
              
                    <span class="icon">关注</span></a></span> 
                    <span class="btn-tbl-cell" style="display: none">

                    <a class="btn-add-cart link" id="btnQukBuy"   itemid="" countdownid="@Model.ProductInfo.CountDownId">
                        加入购物车</a></span> 

                  <span class="btn-tbl-cell" >
                    @*btn-quk-buy*@
                    <a class=" btn-add-cart link" id="btnAddToCart" DefaultText="立刻购买"  itemid="" groupbuyid="@Model.ProductInfo.GroupBuy.GroupBuyId">
                        立刻购买</a>
                </span>
            </div>
        </div>
    </div>
}
<div class="productshow_a">
    <ul>
        <li><a href="@(ViewBag.BasePath)product/productdesc/@Model.ProductInfo.ProductId">商品详情</a></li>
        <li style="display:none"><a href="@(ViewBag.BasePath)product/Consults/@Model.ProductInfo.ProductId">商品咨询</a></li>
    </ul>
</div>
 
<script type="text/javascript">
    $(function() {
        var myclass = new CountDown();
        var endDate = $("#productDate").attr("date");
         var dateEnd =new Date(parseInt(endDate));
        var dateNow = new Date();
        var dateCount = dateEnd.getTime() - dateNow.getTime();
        if (dateCount > 0) {
            myclass.init({
                id: 'txtenddate',
                //天数
                day_Dom: $("#dayEnd"),
                //小时
                hour_Dom: $("#hourEnd"),
                //分钟
                min_Dom: $("#minEnd"),
                //秒
                sec_Dom: $("#secEnd"),
                endTime: endDate
            });
        } else {
            $("#closeActivity").show();
            $('#iteminfo').parent().find('#btnAddToCart').removeClass('addCart').addClass('addCart-gray');
            $('#iteminfo #divBuyInfo').hide();
            $('#iteminfo #divSelectInfo').empty();
        }
        if (@Model.ProductInfo.SaleStatus !== 1) {
            $('#iteminfo').parent().find('#btnAddToCart').removeClass('addCart').addClass('addCart-gray');
            $('#iteminfo #divBuyInfo').hide();
            $('#iteminfo #divSelectInfo').empty();
            $('#iteminfo #closeArrivingNotifyMess').text("非常抱歉, 此商品已下架!");
            $('#iteminfo #closeArrivingNotifyMess').show();
        }

        var maxCount = parseInt('@Model.ProductInfo.GroupBuy.MaxCount');
        var buyCount = parseInt('@Model.ProductInfo.GroupBuy.BuyCount');
        if (buyCount >= maxCount) {
            $("#closeArrivingNotifyMess").show();
            $('#iteminfo').parent().find('#btnAddToCart').removeClass('addCart').addClass('addCart-gray');
            $('#iteminfo #divBuyInfo').hide();
            $('#iteminfo #divSelectInfo').empty();
        }

        $("#btnAddToCart").unbind('click').bind('click',function () {
            if ($(this).hasClass('addCart-gray')) return false;
            var sku = $(this).attr('itemid');
            if (!sku) {
                $('#iteminfo,#iteminfo a').effect('highlight', 500);
                 ShowFailTip('请选择商品规格属性！');
                return false;
            }
            var groupbuyid = $("#hfGroupBuyId").val();
            $.ajax({
                type: "POST",
                dataType: "text",
                url: "@(ViewBag.BasePath)Product/CkeckCount",
                async: false,
                data: { GroupBuyId: groupbuyid },
                success: function (data) {
                    if (data == "Ok") {
                        location.href = " @(ViewBag.BasePath)Order/SubmitOrder?sku=" + sku + "&g=" + groupbuyid;
                    }
                    else {
                        $("#closeArrivingNotifyMess").show();
                        $('#iteminfo').parent().find('#btnAddToCart').removeClass('addCart').addClass('addCart-gray');
                        $('#iteminfo #divBuyInfo').hide();
                        $('#iteminfo #divSelectInfo').empty();
                    }
                }
            });
        });
    })
</script>