@{
    Layout = "~/Areas/MShop/Themes/AKTV/Views/Shared/_BaseLayout.cshtml";
}
@section head{
    <link href="/Scripts/jqueryui/red/jquery-ui-1.9.2.min.css" rel="stylesheet" type="text/css" />
    <link href="/Areas/MShop/Themes/AKTV/Content/Css/ProductStyle.css" rel="stylesheet"/>
    <script src="/Scripts/jquery/jquery.guid.js" type="text/javascript"></script>
    <script src="/Scripts/jquery/maticsoft.selectregion.js" handle="/RegionHandle.aspx"
        isnull="true" type="text/javascript"></script>
        <script src="/Scripts/jquery.cookie.js" type="text/javascript"></script>
}
@section foot{
    <script src="/Scripts/jqueryui/jquery-ui-1.9.2.min.js" type="text/javascript"></script>
    <script src="/Scripts/jqueryui/maticsoft.jqueryui.dialog.min.js" type="text/javascript"></script>
    <script src="/Areas/MShop/Themes/AKTV/Content/Scripts/Pay/SubmitOrder.js" type="text/javascript"></script>
    <script type="text/javascript">
        $(function () {
            //            if ($('#step-1').find('#txtAddressCount').val() < 1) {
            //                Edit_Consignee(null, -1);
            //            }
            $('#order-submit').click(function () {
                var addressId = $('#step-1 .step-content').attr("addressId");
                if (!addressId || addressId < 1) {
                    $.alertEx('请修改收货人信息!', function () {
                        $('#step-1').effect('highlight', 1000);
                        //$('#step-1').effect('shake');
                    });
                    return false;
                }
                var payId = $('#step-2').find('#PaymentModeId').val();
                if (!payId || payId < 1) {
                    $.alertEx('请修改支付方式后提交订单!', function () {
                        $('#step-2').effect('highlight', 1000);
                    });
                    return false;
                }
                var shipId = $('#step-2').find('#ShippingTypeId').val();
                if (!shipId || shipId < 1) {
                    $.alertEx('请修改配送方式后提交订单!', function () {
                        $('#step-2').effect('highlight', 1000);
                    });
                    return false;
                }
                var conpon = $("#hfcoupon").val();
                SubmitOrder(this, addressId, shipId, payId, conpon);
            });
            
            //是否可用优惠券
            IsUseCoupon();
        });



        var CheckLogin = function () {
            var islogin;
            $.ajax({
                url: $YSWL.BasePath + "Account/AjaxIsLogin",
                type: 'post',
                dataType: 'text',
                timeout: 10000,
                async: false,
                success: function (resultData) {
                    if (resultData != "True") {
                        islogin = false;
                        return false;
                    } else {
                        islogin = true;
                        return true;
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                }
            });
            return islogin;
        };
        //是否可用优惠券
        function IsUseCoupon() {
            var useCoupon = $('#hidUseCoupon').val();
            //不是限时抢购/团购
            if (!$.getUrlParam('c') && !$.getUrlParam('g')) {
                $('#orderCouponItem').show();
                return;
            }
            //限时抢购/团购 开启了使用优惠劵
            if (($.getUrlParam('c') || $.getUrlParam('g')) && useCoupon.toLocaleLowerCase() == 'true') {
                $('#orderCouponItem').show();
            }
        }
        //获取赠品及包邮信息
        function GetActivList(couponPrice) {
            $('#activList').load($YSWL.BasePath + 'Order/ActivList', { coupPrice: couponPrice });
        }
        //是否包邮
        function IsFullFreeShipping() {
            if ($('#hidFullFreeShipping').length > 0 && $('#hidFullFreeShipping').val() && $('#hidFullFreeShipping').val().toLocaleLowerCase() == 'true') {
                return true;
            } else {
                return false;
            }
        }

        //获取要购买的商品的库存
        function GetBuyProdStock() {
            $.ajax({
                type: "POST",
                dataType: "json",
                url: $YSWL.BasePath + "Order/GetBuyProdStock",
                async: false,
                success: function (resultJson) {
                    if (resultJson.STATUS == "OK") {
                        var datajson = $.parseJSON(resultJson.DATA);
                        var isShow = false;
                        var htmlstr = '<span class="gou_title" style="color: #F00;">缺货及失效商品</span> <div class="gou_nrtext"  style="background: none;padding: 6px 5px 0 6px;">';
                        for (var i = 0; i < datajson.length; i++) {
                            if (parseInt(datajson[i].salestatus) != 1 || parseInt(datajson[i].stock) <= 0 || parseInt(datajson[i].stock) < parseInt(datajson[i].quantity)) {//无效 无货 库存不足
                                htmlstr += ' <div   class="so_f_left">   <img   width="50" height="50" src="' + datajson[i].pic.format('T50X65_') + '"/></div>';
                                isShow = true;
                            }  
                        }
                        htmlstr += '</div>';
                        if (isShow) {
                            $('#products_nostock_tip').html(htmlstr);
                        } else {
                            $('#products_nostock_tip').html('');
                        }
                    }
                }
            });
        }
    </script>
}
@model YSWL.MALL.Model.Shop.Products.ShoppingCartInfo
<div class="yy">
</div>
<div class="goucontent">
<input  type="hidden" id="hdIsMultiDepot" value="@ViewBag.IsMultiDepot"/>
    <input  type="hidden" id="hidUseCoupon" value="@ViewBag.PromotionsIsUseCoupon"/>
    <input type="hidden" id="SkuInfo" value="@ViewBag.SkuInfo"/>
    <input type="hidden" id="SkuCount" value="@ViewBag.SkuCount"/>
    <input type="hidden" id="ProSale" value="@ViewBag.ProSale"/>
    <input type="hidden" id="GroupBuy" value="@ViewBag.GroupBuy"/>
    <span class="gou_title">收货人信息</span>
    <div class="gou_nrtext" id="step-1">
        @Html.Action("ShowAddress", "Order")
    </div>
    <span class="gou_title">支付及配送方式</span>
    <div class="gou_nrtext" id="step-2">
        @Html.Action("ShowPayAndShip", "Order")
    </div>
    <span class="gou_title" style="display: none">发票信息</span>
    <div class="gou_nrtext" style="display: none">
        <span><a href="#">发票类型：普通发票</a></span><span><a href="#">发票抬头： 个人 </a></span><span><a
                                                                                              href="#">非图书商品： 明细</a></span></div>
   <div class="gou_nrtext order_coupon" id="orderCouponItem" style="display:none;margin-top: 5px;min-height:30px;">
      @Html.Action("ShowCoupon", "Order", new { cartInfo=Model })
    </div>
   <div  id="products_nostock_tip" >
        @if (Model.Items != null)
        {
            int i = 0;//失效、无库存、库存不足 商品数
            <span class="gou_title" style="color: #F00;">缺货及失效商品</span>
            <div class="gou_nrtext" style="background: none; padding: 6px 5px 0 6px;">
                @foreach (var item in Model.Items)
                {
                    if (item.SaleStatus != 1 || item.Stock <= 0 || item.Stock < item.Quantity)
                    {
                        i++;
                    <div class="so_f_left">
                        <img   width="50" height="50" src="@YSWL.MALL.Web.Components.FileHelper.GeThumbImage(item.ThumbnailsUrl, "T50X65_")" /></div>        
                    }
                 }
            </div>
            <input type="hidden"  id="shixiaoshangpin" value="@i" /> //含有 失效、无库存、库存不足 商品 时才展示
                                                      <script type="text/javascript">
                                                          if (parseInt($('#shixiaoshangpin').val()) > 0) {
                                                              $('#products_nostock_tip').show();
                                                          } else {
                                                              $('#products_nostock_tip').hide();
                                                          }
                                                      </script>
            
    }
   
    </div>
 
    <div align="right" class="fhdd" >
        <a href="@(ViewBag.BasePath)sc/ci" style="color: #3c3c3c; " class="order_back_cart"  id="order_tuan_submit">
            返回购物车  
        </a></div>
    <div class="gou_nrjiage">
        <span><em>商品金额：</em>￥@ViewBag.ProductTotal.ToString("F")</span>
        <span><em>+ 运费：</em>
            <span class="price" id="freightPriceId" freightPrice="0">￥@ViewBag.Freight.ToString("F")</span>
        </span>
        <span><em>- 促销：</em>
            <span id="promotionsPriceId">￥@ViewBag.TotalPromPrice.ToString("F")</span></span>
        <span><em>- 优惠：</em>
            <span id="couponPriceId" couponPrice="0">￥0.00</span>
        </span>
        <span>
            <em>应付总额：</em>
            <strong id="payPriceId" BasePrice="@ViewBag.TotalPrice"  >
                ￥@ViewBag.TotalPrice.ToString("F")
            </strong>
        </span>
    </div>

    <!--赠品-->
    <div id="activList"></div>
    <!--赠品-->
    <div>
        <input type="submit" value="提交订单" id="order-submit" class="sub_btn" style="border-radius: 5px;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            border: 1px solid rgb(164, 164, 164);"/></div>
</div>
